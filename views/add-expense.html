<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Expense</title>
    <link rel="stylesheet" href="../css/add-expense.css">
</head>
<body>
    <header class="main-header">
        <h1>Add Expense</h1>
    </header>
    <main>
        <form action="/expense/addexpense" method="POST" onsubmit="AddExpense(event)">
            <div class="form-control">
                <label>Money spent(in Rs):</label>
                <input id="amount" type="number" name="amount" required />
                <label>Item description:</label>
                <input id="description" type="text" name="description" required />
                <label for="category">Category:</label>
                <select name="category" id="category">
                    <option value="food">Food</option>
                    <option value="petrol">Petrol</option>
                    <option value="movie">Movies</option>
                    <option value="ticket">Flight tickets</option>
                </select>
                <button id="add-bttn" type="submit">Add Expense</button>
            </div>
        </form>
        <button id="payment">Buy Premium</button>
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        
        <ul id="expenses"></ul>
    </main>
    <script>
        document.getElementById('payment').addEventListener('click', async function payment(e){
            try{
                const token= localStorage.getItem('token')
                const response= await fetch('http://localhost:3000/payment/transactions',{
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json',
                    }
                })
                const data= await response.json()
                var options={
                    "key": data.key_id,
                    "order_id": data.orderid,
                    "headers": async function update(response){
                        await fetch('http://localhost:3000/payment/updatetransactions',{
                            method: 'POST',
                            body: JSON.stringify({
                                order_id: options.order_id,
                                payment_id: response.razorpay_payment_id
                            }),
                            headers: {
                               'Authorization': token,
                               'Content-Type': 'application/json',
                            }
                            
                        })
                        alert('You are a premium user')
                    }
                }
            }catch (err){
                console.log(err)
            }
        })
        const bttn=document.getElementById('add-bttn')
        bttn.addEventListener('click', async function AddExpense(e){
            e.preventDefault()
            try{
                const amount= document.getElementById('amount').value
                const description= document.getElementById('description').value
                const category= document.getElementById('category').value
                const token= localStorage.getItem('token')
                const res = await fetch('http://localhost:3000/expense/addexpense',{
                    method: 'POST',
                    body: JSON.stringify({
                        amount,
                        description,
                        category
                    }),
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json',
                    } });
                    if(res.ok){
                        alert('new Expense added')
                    }
            }catch(err){
                console.log(err)
            }
            window.location.href='./add-expense.html'
        })
        window.addEventListener('DOMContentLoaded', async () => {
            
            try {
                const token= localStorage.getItem('token')
                
                const res = await fetch('http://localhost:3000/expense/fetchexpenses',{
                    headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json',
                } });
                const data = await res.json();
                console.log(data);
                if (data && data.allexpenses) {
                    data.allexpenses.forEach(expense => {
                        showExpense(expense);
                    });
                } else {
                    throw new Error('Something went wrong');
                }
            } catch (err) {
                console.log(err);
            }
        });

        function showExpense(expense) {
            const ul = document.getElementById('expenses');
            const bttn = document.createElement('button');
            bttn.id = 'del';
            bttn.textContent = 'Delete';
            const li = document.createElement('li');
            li.id = expense.id;
            li.textContent = `Expense: ${expense.description}; Category: ${expense.category}; Money spent: ${expense.amount}`;
            li.appendChild(bttn);
            ul.appendChild(li); 
            bttn.addEventListener('click', () => { deleteExpense(expense.id)});
        }
        async function deleteExpense(id){
            console.log(`Delete button clicked for expense with ID: ${id}`);
            const ul=  document.getElementById('expenses');
            const token= localStorage.getItem('token')
            const response= await fetch(`http://localhost:3000/expense/deleteexpense/${id}`,{
                method: 'DELETE',
                headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json',
                } 
            })
            const data= await response.json()
            if (data.success) {
                const li = document.getElementById(id);
                ul.removeChild(li);
            }
        }
    </script>
</body>
</html>
